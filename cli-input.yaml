BlockDeviceMappings:
- DeviceName: /dev/sda1
  Ebs:
    DeleteOnTermination: true
    Encrypted: false
    VolumeSize: 40
    VolumeType: gp2
  VirtualName: sda1
IamInstanceProfile:
  Name: dataforce-dev-access-profile
ImageId: ami-08f0bc76ca5236b20
InstanceInitiatedShutdownBehavior: terminate
InstanceType: r6g.medium
KeyName: dataforce-dev
MaxCount: 1
MinCount: 1
Monitoring:
  Enabled: false
NetworkInterfaces:
- AssociatePublicIpAddress: true
  DeleteOnTermination: true
  Description: public
  DeviceIndex: 0
  Groups:
  - sg-032ad43da2c9d3e26
  SubnetId: subnet-0b92837ec9c5b402e
TagSpecifications:
- ResourceType: instance
  Tags:
  - Key: Name
    Value: drone-worker-DRONE_REPO-DRONE_COMMIT_BRANCH-DRONE_COMMIT_SHA
  - Key: Git Repository
    Value: DRONE_REPO
  - Key: Git Branch
    Value: DRONE_COMMIT_BRANCH
  - Key: Git Commit
    Value: DRONE_COMMIT_SHA
UserData: "#cloud-config\ngroups:\n- docker\nruncmd:\n- curl -fsSL https://download.docker.com/linux/ubuntu/gpg\
  \ | apt-key add -\n- add-apt-repository \"deb [arch=amd64] https://download.docker.com/linux/ubuntu\
  \ $(lsb_release\n  -cs) stable\"\n- apt-get update -y\n- apt-get upgrade -y\n- apt-get\
  \ install -y docker-ce docker-ce-cli containerd.io binutils s3fs awscli\n- systemctl\
  \ start docker\n- systemctl enable docker\n- mkdir -p /mnt/vault\n- s3fs dataforce-dev:/remotes/vault\
  \ /mnt/vault -o iam_role=dataforce-dev-access -o\n  url=http://s3.ap-southeast-2.amazonaws.com\
  \ -o allow_other -o use_cache=/tmp\n- mkdir -p /mnt/pond\n- s3fs dataforce-dev:/remotes/pond\
  \ /mnt/pond -o iam_role=dataforce-dev-access -o url=http://s3.ap-southeast-2.amazonaws.com\n\
  \  -o allow_other -o use_cache=/tmp\n- mkdir -p /mnt/rapid\n- s3fs dataforce-dev:/remotes/rapid\
  \ /mnt/rapid -o iam_role=dataforce-dev-access -o\n  url=http://s3.ap-southeast-2.amazonaws.com\
  \ -o allow_other -o use_cache=/tmp\n- mkdir -p /mnt/logs\n- s3fs dataforce-dev:/remotes/logs\
  \ /mnt/logs -o iam_role=dataforce-dev-access -o url=http://s3.ap-southeast-2.amazonaws.com\n\
  \  -o allow_other -o use_cache=/tmp\n- aws ecr get-login-password --region ap-southeast-2\
  \ | docker login --username AWS\n  --password-stdin 325729004853.dkr.ecr.ap-southeast-2.amazonaws.com\n\
  - docker run --detach --rm --volume /mnt/pond:/mnt/pond --volume /mnt/vault:/mnt/vault\n\
  \  --volume /mnt/rapid:/mnt/rapid --workdir /root/src/abyss/abyss-fabric 325729004853.dkr.ecr.ap-southeast-2.amazonaws.com/abyss/abyss-fabric:test\n\
  \  make test | xargs docker logs --follow > /mnt/logs/docker-run-make-test.log\n\
  - shutdown --poweroff now\nsystem_info:\n  default_user:\n    groups:\n    - docker\n"
